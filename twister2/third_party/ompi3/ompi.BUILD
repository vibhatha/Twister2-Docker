licenses(["notice"])

package(default_visibility = ["//visibility:public"])

bin_files = ["bin/shmemfort",
                          "bin/shmemcc",
                          "bin/opal_wrapper",
                          "bin/mpiexec",
                          "bin/ompi-dvm",
                          "bin/orted",
                          "bin/mpirun",
                          "bin/oshc++",
                          "bin/mpijavac",
                          "bin/mpicxx",
                          "bin/orte-top",
                          "bin/orte-ps",
                          "bin/oshrun",
                          "bin/orte-server",
                          "bin/shmemcxx",
                          "bin/mpicc",
                          "bin/aggregate_profile.pl",
                          "bin/orte-dvm",
                          "bin/shmemCC",
                          "bin/ompi-ps",
                          "bin/mpif77",
                          "bin/mpijavac.pl",
                          "bin/oshfort",
                          "bin/oshmem_info",
                          "bin/ompi_info",
                          "bin/mpiCC",
                          "bin/ompi-clean",
                          "bin/orte-info",
                          "bin/mpifort",
                          "bin/oshcc",
                          "bin/shmemrun",
                          "bin/orte-clean",
                          "bin/oshcxx",
                          "bin/prun",
                          "bin/mpic++",
                          "bin/ortecc",
                          "bin/profile2mat.pl",
                          "bin/orterun",
                          "bin/shmemc++",
                          "bin/ompi-server",
                          "bin/mpif90",
                          "bin/ompi-top",
                          "bin/oshCC",]

etc_files = ["etc/openmpi-totalview.tcl",
                          "etc/openmpi-default-hostfile",
                          "etc/pmix-mca-params.conf",
                          "etc/openmpi-mca-params.conf",]

include_files = ["include/shmem-compat.h",
                              "include/pshmem.h",
                              "include/mpp/shmem.fh",
                              "include/mpp/shmem.h",
                              "include/shmem.fh",
                              "include/mpif-ext.h",
                              "include/openshmem/oshmem/types.h",
                              "include/openshmem/oshmem/frameworks.h",
                              "include/openshmem/oshmem/version.h",
                              "include/openshmem/oshmem/constants.h",
                              "include/openshmem/oshmem_config.h",
                              "include/openmpi/ompi/mpiext/affinity/c/mpiext_affinity_c.h",
                              "include/openmpi/ompi/mpiext/cuda/c/mpiext_cuda_c.h",
                              "include/openmpi/ompi/mpi/java/mpiJava.h",
                              "include/mpif-c-constants-decl.h",
                              "include/mpi.h",
                              "include/shmemx.h",
                              "include/mpif.h",
                              "include/mpi_portable_platform.h",
                              "include/pshmemx.h",
                              "include/mpif-sizeof.h",
                              "include/shmem.h",
                              "include/mpi-ext.h",]

lib_files = ["lib/libopen-pal.so",
                          "lib/libopen-rte.so.40",
                          "lib/libmca_common_ompio.so.41.9.0",
                          "lib/libmca_common_monitoring.so.50.0.0",
                          "lib/libopen-rte.so",
                          "lib/libmca_common_monitoring.so.50",
                          "lib/libopen-rte.so.40.10.2",
                          "lib/libmpi.la",
                          "lib/libompitrace.so",
                          "lib/libmpi_java.so.40",
                          "lib/ompi_monitoring_prof.la",
                          "lib/ompi_monitoring_prof.so",
                          "lib/libmpi_java.so.40.10.0",
                          "lib/libmpi.so.40.10.2",
                          "lib/openmpi/mca_rmaps_round_robin.so",
                          "lib/openmpi/mca_errmgr_dvm.la",
                          "lib/openmpi/mca_oob_tcp.so",
                          "lib/openmpi/mca_sshmem_sysv.so",
                          "lib/openmpi/mca_rml_oob.la",
                          "lib/openmpi/mca_pml_ob1.so",
                          "lib/openmpi/mca_regx_fwd.la",
                          "lib/openmpi/mca_ess_tool.so",
                          "lib/openmpi/mca_coll_inter.la",
                          "lib/openmpi/mca_osc_monitoring.la",
                          "lib/openmpi/mca_fcoll_static.so",
                          "lib/openmpi/mca_state_orted.la",
                          "lib/openmpi/mca_osc_sm.la",
                          "lib/openmpi/mca_fbtl_posix.la",
                          "lib/openmpi/mca_plm_slurm.la",
                          "lib/openmpi/mca_errmgr_default_tool.la",
                          "lib/openmpi/mca_rmaps_rank_file.la",
                          "lib/openmpi/mca_scoll_mpi.so",
                          "lib/openmpi/mca_sshmem_mmap.so",
                          "lib/openmpi/mca_shmem_posix.so",
                          "lib/openmpi/mca_atomic_basic.la",
                          "lib/openmpi/mca_coll_basic.so",
                          "lib/openmpi/mca_compress_bzip.la",
                          "lib/openmpi/mca_rmaps_mindist.so",
                          "lib/openmpi/mca_memheap_buddy.la",
                          "lib/openmpi/mca_dfs_app.la",
                          "lib/openmpi/mca_coll_spacc.so",
                          "lib/openmpi/mca_routed_radix.so",
                          "lib/openmpi/mca_mpool_hugepage.la",
                          "lib/openmpi/mca_odls_default.so",
                          "lib/openmpi/mca_compress_gzip.la",
                          "lib/openmpi/mca_compress_gzip.so",
                          "lib/openmpi/mca_schizo_flux.so",
                          "lib/openmpi/mca_fcoll_static.la",
                          "lib/openmpi/mca_btl_self.la",
                          "lib/openmpi/mca_fcoll_individual.so",
                          "lib/openmpi/mca_osc_rdma.la",
                          "lib/openmpi/mca_regx_fwd.so",
                          "lib/openmpi/mca_plm_slurm.so",
                          "lib/openmpi/mca_errmgr_default_tool.so",
                          "lib/openmpi/mca_ras_simulator.so",
                          "lib/openmpi/mca_notifier_syslog.la",
                          "lib/openmpi/mca_btl_sm.la",
                          "lib/openmpi/mca_pml_cm.so",
                          "lib/openmpi/mca_coll_spacc.la",
                          "lib/openmpi/mca_grpcomm_direct.la",
                          "lib/openmpi/mca_coll_sm.so",
                          "lib/openmpi/mca_io_romio314.la",
                          "lib/openmpi/mca_pmix_isolated.so",
                          "lib/openmpi/mca_shmem_mmap.la",
                          "lib/openmpi/mca_crs_none.so",
                          "lib/openmpi/mca_errmgr_default_orted.la",
                          "lib/openmpi/mca_state_novm.la",
                          "lib/openmpi/mca_plm_isolated.so",
                          "lib/openmpi/mca_filem_raw.so",
                          "lib/openmpi/mca_osc_sm.so",
                          "lib/openmpi/mca_routed_binomial.la",
                          "lib/openmpi/mca_coll_sm.la",
                          "lib/openmpi/mca_ras_slurm.la",
                          "lib/openmpi/mca_ess_pmi.la",
                          "lib/openmpi/mca_ess_tool.la",
                          "lib/openmpi/mca_rmaps_rank_file.so",
                          "lib/openmpi/mca_atomic_basic.so",
                          "lib/openmpi/mca_state_tool.so",
                          "lib/openmpi/mca_dfs_orted.so",
                          "lib/openmpi/mca_fcoll_two_phase.so",
                          "lib/openmpi/mca_rmaps_resilient.la",
                          "lib/openmpi/mca_routed_direct.so",
                          "lib/openmpi/mca_pml_monitoring.la",
                          "lib/openmpi/mca_shmem_sysv.so",
                          "lib/openmpi/mca_compress_bzip.so",
                          "lib/openmpi/mca_btl_vader.so",
                          "lib/openmpi/mca_errmgr_default_hnp.so",
                          "lib/openmpi/mca_coll_basic.la",
                          "lib/openmpi/mca_iof_hnp.so",
                          "lib/openmpi/mca_errmgr_default_app.la",
                          "lib/openmpi/mca_ess_env.la",
                          "lib/openmpi/mca_fcoll_dynamic_gen2.la",
                          "lib/openmpi/mca_coll_self.la",
                          "lib/openmpi/mca_plm_rsh.la",
                          "lib/openmpi/mca_iof_tool.so",
                          "lib/openmpi/mca_rcache_grdma.la",
                          "lib/openmpi/mca_fs_ufs.la",
                          "lib/openmpi/mca_errmgr_default_hnp.la",
                          "lib/openmpi/mca_routed_binomial.so",
                          "lib/openmpi/mca_sharedfp_individual.la",
                          "lib/openmpi/mca_rml_oob.so",
                          "lib/openmpi/mca_ess_singleton.so",
                          "lib/openmpi/mca_iof_orted.la",
                          "lib/openmpi/mca_pmix_isolated.la",
                          "lib/openmpi/mca_topo_treematch.la",
                          "lib/openmpi/mca_errmgr_default_orted.so",
                          "lib/openmpi/mca_dfs_app.so",
                          "lib/openmpi/mca_ess_slurm.so",
                          "lib/openmpi/mca_ras_slurm.so",
                          "lib/openmpi/mca_oob_tcp.la",
                          "lib/openmpi/mca_reachable_weighted.la",
                          "lib/openmpi/mca_fcoll_dynamic.so",
                          "lib/openmpi/mca_iof_tool.la",
                          "lib/openmpi/mca_allocator_basic.la",
                          "lib/openmpi/libompi_dbg_msgq.so",
                          "lib/openmpi/mca_pml_cm.la",
                          "lib/openmpi/mca_pml_monitoring.so",
                          "lib/openmpi/mca_routed_radix.la",
                          "lib/openmpi/mca_schizo_flux.la",
                          "lib/openmpi/mca_state_hnp.so",
                          "lib/openmpi/mca_odls_default.la",
                          "lib/openmpi/mca_schizo_slurm.so",
                          "lib/openmpi/mca_pmix_flux.so",
                          "lib/openmpi/mca_filem_raw.la",
                          "lib/openmpi/mca_btl_tcp.so",
                          "lib/openmpi/mca_rtc_hwloc.so",
                          "lib/openmpi/mca_patcher_overwrite.la",
                          "lib/openmpi/mca_pml_ob1.la",
                          "lib/openmpi/mca_sharedfp_individual.so",
                          "lib/openmpi/mca_btl_tcp.la",
                          "lib/openmpi/mca_schizo_slurm.la",
                          "lib/openmpi/mca_pmix_pmix2x.la",
                          "lib/openmpi/mca_reachable_weighted.so",
                          "lib/openmpi/mca_pmix_flux.la",
                          "lib/openmpi/mca_rmaps_round_robin.la",
                          "lib/openmpi/mca_pstat_linux.la",
                          "lib/openmpi/mca_coll_libnbc.la",
                          "lib/openmpi/mca_sshmem_mmap.la",
                          "lib/openmpi/mca_scoll_mpi.la",
                          "lib/openmpi/mca_state_dvm.so",
                          "lib/openmpi/mca_io_ompio.la",
                          "lib/openmpi/mca_btl_self.so",
                          "lib/openmpi/mca_state_novm.so",
                          "lib/openmpi/mca_state_hnp.la",
                          "lib/openmpi/mca_plm_rsh.so",
                          "lib/openmpi/mca_sharedfp_lockedfile.la",
                          "lib/openmpi/mca_errmgr_default_app.so",
                          "lib/openmpi/mca_coll_tuned.la",
                          "lib/openmpi/mca_fcoll_individual.la",
                          "lib/openmpi/mca_allocator_bucket.la",
                          "lib/openmpi/mca_shmem_sysv.la",
                          "lib/openmpi/mca_coll_inter.so",
                          "lib/openmpi/mca_coll_sync.la",
                          "lib/openmpi/mca_vprotocol_pessimist.so",
                          "lib/openmpi/mca_rmaps_ppr.la",
                          "lib/openmpi/mca_rmaps_mindist.la",
                          "lib/openmpi/mca_bml_r2.la",
                          "lib/openmpi/mca_state_orted.so",
                          "lib/openmpi/mca_notifier_syslog.so",
                          "lib/openmpi/mca_ess_env.so",
                          "lib/openmpi/mca_schizo_orte.la",
                          "lib/openmpi/mca_pstat_linux.so",
                          "lib/openmpi/mca_coll_libnbc.so",
                          "lib/openmpi/mca_vprotocol_pessimist.la",
                          "lib/openmpi/libompi_dbg_msgq.la",
                          "lib/openmpi/mca_state_dvm.la",
                          "lib/openmpi/mca_regx_reverse.la",
                          "lib/openmpi/mca_coll_self.so",
                          "lib/openmpi/mca_fcoll_two_phase.la",
                          "lib/openmpi/mca_dfs_test.la",
                          "lib/openmpi/mca_routed_direct.la",
                          "lib/openmpi/mca_ess_singleton.la",
                          "lib/openmpi/mca_rmaps_ppr.so",
                          "lib/openmpi/mca_rmaps_seq.la",
                          "lib/openmpi/mca_sharedfp_sm.so",
                          "lib/openmpi/mca_state_tool.la",
                          "lib/openmpi/mca_schizo_orte.so",
                          "lib/openmpi/mca_routed_debruijn.so",
                          "lib/openmpi/mca_sshmem_sysv.la",
                          "lib/openmpi/mca_fs_ufs.so",
                          "lib/openmpi/mca_memheap_ptmalloc.la",
                          "lib/openmpi/mca_regx_reverse.so",
                          "lib/openmpi/mca_coll_monitoring.la",
                          "lib/openmpi/mca_topo_treematch.so",
                          "lib/openmpi/mca_state_app.so",
                          "lib/openmpi/mca_rtc_hwloc.la",
                          "lib/openmpi/mca_iof_hnp.la",
                          "lib/openmpi/mca_topo_basic.so",
                          "lib/openmpi/mca_schizo_ompi.so",
                          "lib/openmpi/mca_fcoll_dynamic_gen2.so",
                          "lib/openmpi/mca_crs_none.la",
                          "lib/openmpi/mca_mpool_hugepage.so",
                          "lib/openmpi/mca_ess_hnp.la",
                          "lib/openmpi/mca_btl_sm.so",
                          "lib/openmpi/mca_osc_monitoring.so",
                          "lib/openmpi/mca_routed_debruijn.la",
                          "lib/openmpi/mca_bml_r2.so",
                          "lib/openmpi/mca_patcher_overwrite.so",
                          "lib/openmpi/mca_shmem_mmap.so",
                          "lib/openmpi/mca_dfs_orted.la",
                          "lib/openmpi/mca_ras_simulator.la",
                          "lib/openmpi/mca_osc_pt2pt.so",
                          "lib/openmpi/mca_rmaps_seq.so",
                          "lib/openmpi/mca_memheap_buddy.so",
                          "lib/openmpi/mca_osc_rdma.so",
                          "lib/openmpi/mca_rcache_grdma.so",
                          "lib/openmpi/mca_shmem_posix.la",
                          "lib/openmpi/mca_allocator_basic.so",
                          "lib/openmpi/mca_coll_tuned.so",
                          "lib/openmpi/mca_dfs_test.so",
                          "lib/openmpi/mca_sharedfp_lockedfile.so",
                          "lib/openmpi/mca_rmaps_resilient.so",
                          "lib/openmpi/mca_state_app.la",
                          "lib/openmpi/mca_allocator_bucket.so",
                          "lib/openmpi/mca_schizo_ompi.la",
                          "lib/openmpi/mca_osc_pt2pt.la",
                          "lib/openmpi/mca_topo_basic.la",
                          "lib/openmpi/mca_btl_vader.la",
                          "lib/openmpi/mca_memheap_ptmalloc.so",
                          "lib/openmpi/mca_scoll_basic.so",
                          "lib/openmpi/mca_fbtl_posix.so",
                          "lib/openmpi/mca_coll_sync.so",
                          "lib/openmpi/mca_io_ompio.so",
                          "lib/openmpi/mca_ess_slurm.la",
                          "lib/openmpi/mca_sharedfp_sm.la",
                          "lib/openmpi/mca_iof_orted.so",
                          "lib/openmpi/mca_errmgr_dvm.so",
                          "lib/openmpi/mca_scoll_basic.la",
                          "lib/openmpi/mca_ess_hnp.so",
                          "lib/openmpi/mca_grpcomm_direct.so",
                          "lib/openmpi/mca_coll_monitoring.so",
                          "lib/openmpi/mca_fcoll_dynamic.la",
                          "lib/openmpi/mca_ess_pmi.so",
                          "lib/openmpi/mca_plm_isolated.la",
                          "lib/openmpi/mca_pmix_pmix2x.so",
                          "lib/openmpi/mca_io_romio314.so",
                          "lib/libmca_common_ompio.so.41",
                          "lib/libopen-pal.so.40",
                          "lib/libmca_common_sm.so",
                          "lib/libopen-rte.la",
                          "lib/libmca_common_ompio.la",
                          "lib/libopen-pal.la",
                          "lib/libopen-pal.so.40.10.2",
                          "lib/liboshmem.la",
                          "lib/libmpi.so.40",
                          "lib/libmca_common_sm.la",
                          "lib/pmix/mca_preg_native.so",
                          "lib/pmix/mca_psensor_heartbeat.so",
                          "lib/pmix/mca_psec_none.la",
                          "lib/pmix/mca_ptl_tcp.la",
                          "lib/pmix/mca_ptl_usock.so",
                          "lib/pmix/mca_psensor_file.so",
                          "lib/pmix/mca_gds_ds12.la",
                          "lib/pmix/mca_bfrops_v20.so",
                          "lib/pmix/mca_psensor_heartbeat.la",
                          "lib/pmix/mca_bfrops_v12.la",
                          "lib/pmix/mca_gds_ds12.so",
                          "lib/pmix/mca_bfrops_v12.so",
                          "lib/pmix/mca_psec_none.so",
                          "lib/pmix/mca_bfrops_v21.la",
                          "lib/pmix/mca_bfrops_v20.la",
                          "lib/pmix/mca_ptl_tcp.so",
                          "lib/pmix/mca_psensor_file.la",
                          "lib/pmix/mca_psec_native.la",
                          "lib/pmix/mca_bfrops_v21.so",
                          "lib/pmix/mca_pshmem_mmap.so",
                          "lib/pmix/mca_preg_native.la",
                          "lib/pmix/mca_gds_hash.so",
                          "lib/pmix/mca_psec_native.so",
                          "lib/pmix/mca_gds_hash.la",
                          "lib/pmix/mca_pshmem_mmap.la",
                          "lib/pmix/mca_ptl_usock.la",
                          "lib/liboshmem.so",
                          "lib/libompitrace.la",
                          "lib/libmpi_java.so",
                          "lib/libmpi_java.la",
                          "lib/libmca_common_sm.so.40.10.0",
                          "lib/mpi.jar",
                          "lib/libmca_common_monitoring.so",
                          "lib/libmca_common_ompio.so",
                          "lib/libompitrace.so.40.10.0",
                          "lib/libmca_common_sm.so.40",
                          "lib/liboshmem.so.40",
                          "lib/libmca_common_monitoring.la",
                          "lib/liboshmem.so.40.10.1",
                          "lib/libompitrace.so.40",
                          "lib/pkgconfig/ompi-cxx.pc",
                          "lib/pkgconfig/ompi-fort.pc",
                          "lib/pkgconfig/ompi.pc",
                          "lib/pkgconfig/ompi-c.pc",
                          "lib/pkgconfig/ompi-f90.pc",
                          "lib/pkgconfig/ompi-f77.pc",
                          "lib/pkgconfig/orte.pc",
                          "lib/libmpi.so",]

out_files = bin_files + etc_files + include_files + lib_files

genrule(
    name = "ompi-srcs",
    outs = bin_files + etc_files + include_files + lib_files,
    local = 1,
    cmd = "\n".join([
        'export INSTALL_DIR=$$(pwd)/$(@D)',
        'export TMP_DIR=$$(mktemp -d -t ompi.XXXXX)',
        'mkdir -p $$TMP_DIR',
        'cp -pLR $$(pwd)/external/ompi3/* $$TMP_DIR',
        'cd $$TMP_DIR',
        './configure --prefix=$$INSTALL_DIR --enable-mpi-java',
        'make install',
        'rm -rf $$TMP_DIR',
    ]),
)

filegroup(
    name = "ompi-lib-files",
    srcs = lib_files,
)

filegroup(
    name = "ompi-bin-files",
    srcs = bin_files,
)

filegroup(
    name = "ompi-include-files",
    srcs = include_files,
)

filegroup(
    name = "ompi-etc-files",
    srcs = etc_files,
)